{% load static %}
{% load i18n %}
{% load bootstrap3 %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="{{ INTERFACE.favicon }}" type="image/x-icon">
    <title>{% trans 'USB Key Authentication' %}</title>

    {% include '_head_css_js.html' %}
    <link href="{% static 'css/jumpserver.css' %}" rel="stylesheet">
    <style>
        .passwordBox {
            max-width: 560px;
            margin: 0 auto;
            padding: 100px 20px 20px 20px;
        }
        .usb-key-status {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }
        .usb-key-status.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .usb-key-status.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .usb-key-status.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>

<body class="gray-bg">
    <div class="passwordBox animated fadeInDown">
        <div class="row">
            <div class="col-md-12">
                <div class="ibox-content">
                    <h2 class="font-bold">
                        {% trans 'USB Key Multi-Factor Authentication' %}
                    </h2>
                    <div style="margin: 10px 0">
                        <form class="m-t" role="form" method="post" action="" id="usb-key-form">
                            {% csrf_token %}
                            
                            <div id="usb-key-status" class="usb-key-status"></div>
                            
                            <p>{% trans 'Please insert your USB Key and enter the PIN below!' %}</p>
                            
                            <div class="form-group">
                                <label for="pin">{% trans 'USB Key PIN' %}</label>
                                <input type="password" class="form-control" id="pin" placeholder="{% trans 'Enter USB Key PIN' %}" required>
                            </div>
                            
                            <div class="form-group">
                                <input id="signatureValue-hidden" type="hidden" name="sign_value">
                                <input id="random" type="hidden" name="random">
                                <input id="server-random" type="hidden" name="server_random" value="{{ server_random|default:'' }}">
                                <input id="username" type="hidden" name="username" value="{{ username|default:'' }}">
                                <input id="next" type="hidden" name="next" value="{{ next_url|default:'/' }}">
                            </div>
                            
                            {% if 'code' in form.errors %}
                            <p class="red-fonts">{{ form.code.errors.as_text }}</p>
                            {% endif %}
                            
                            <button type="submit" class="btn btn-primary block full-width m-b" onclick="authenticateUSBKey(event)">
                                {% trans 'Authenticate' %}
                            </button>
                            
                            <div class="text-center" style="margin-top: 10px;">
                                <label>
                                    <input type="checkbox" id="debug-mode" style="margin-right: 5px;">
                                    {% trans 'Debug Mode (Show Network Details)' %}
                                </label>
                            </div>
                            
                            <div class="text-center" style="margin-top: 10px;">
                                <a href="{% url 'authentication:login' %}" class="btn btn-link">
                                    {% trans 'Back to Login' %}
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <hr />
        <div class="row">
            <div class="col-md-12">
                {% include '_copyright.html' %}
            </div>
        </div>
    </div>
</body>

{% include '_foot_js.html' %}
<script type="text/javascript" src="{% static 'js/plugins/jsencrypt/jsencrypt.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/plugins/cryptojs/crypto-js.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/plugins/buffer/buffer.min.js' %}"></script>
<script type="text/javascript" src="{% static 'js/ukeyfunc.js' %}"></script>

<script>
    let ukeyPlugin = null;
    let isAuthenticating = false;

    // 动态加载脚本
    function loadScriptOnce(src) {
        return new Promise((resolve, reject) => {
            if (document.querySelector('script[src="' + src + '"]')) {
                return resolve();
            }
            const s = document.createElement('script');
            s.src = src;
            s.onload = resolve;
            s.onerror = reject;
            document.head.appendChild(s);
        });
    }

    // 初始化USB Key插件（带回退加载）
    async function initUSBKeyPlugin() {
        try {
            if (typeof zaykPlugin === 'function') {
                ukeyPlugin = new zaykPlugin();
                console.log('[USBKey] plugin detected from initial load');
                showStatus('info', '{% trans "USB Key plugin loaded successfully" %}');
                return true;
            }

            console.warn('[USBKey] zaykPlugin not found, trying to load /static/js/ukeyfunc.js again...');
            try { await loadScriptOnce('{% static "js/ukeyfunc.js" %}'); } catch (e) { console.warn('[USBKey] load static ukeyfunc.js failed', e); }
            await new Promise(r => setTimeout(r, 100));
            if (typeof zaykPlugin === 'function') {
                ukeyPlugin = new zaykPlugin();
                console.log('[USBKey] plugin loaded from /static/js/ukeyfunc.js');
                showStatus('info', '{% trans "USB Key plugin loaded successfully" %}');
                return true;
            }

            console.warn('[USBKey] still not found, trying fallback /ukeyfunc.js ...');
            try { await loadScriptOnce('/ukeyfunc.js'); } catch (e) { console.warn('[USBKey] load /ukeyfunc.js failed', e); }
            await new Promise(r => setTimeout(r, 100));
            if (typeof zaykPlugin === 'function') {
                ukeyPlugin = new zaykPlugin();
                console.log('[USBKey] plugin loaded from /ukeyfunc.js');
                showStatus('info', '{% trans "USB Key plugin loaded successfully" %}');
                return true;
            }

            console.error('[USBKey] zaykPlugin still not available after dynamic loading attempts');
            showStatus('error', '{% trans "USB Key plugin not available. Please refresh the page and try again." %}');
            return false;
        } catch (e) {
            console.error('[USBKey] init plugin error:', e);
            showStatus('error', '{% trans "USB Key plugin not available. Please refresh the page and try again." %}');
            return false;
        }
    }

    // 显示状态信息
    function showStatus(type, message) {
        const statusDiv = document.getElementById('usb-key-status');
        statusDiv.className = `usb-key-status ${type}`;
        statusDiv.textContent = message;
        statusDiv.style.display = 'block';
    }

    // 隐藏状态信息
    function hideStatus() {
        const statusDiv = document.getElementById('usb-key-status');
        statusDiv.style.display = 'none';
    }

    // USB Key认证函数
    function authenticateUSBKey(event) {
        event.preventDefault();
        
        if (isAuthenticating) {
            return;
        }
        
        if (!ukeyPlugin) {
            showStatus('error', '{% trans "USB Key plugin not available" %}');
            return;
        }
        
        const pin = document.getElementById('pin').value;
        if (!pin) {
            showStatus('error', '{% trans "Please enter USB Key PIN" %}');
            return;
        }
        
        isAuthenticating = true;
        hideStatus();
        
        try {
            // 1. 连接USB Key
            console.log('Step 1: Connecting to USB Key device...');
            const connectResult = ukeyPlugin.SOF_DeviceConnect();
            console.log('Connect result:', connectResult);
            
            if (connectResult !== 0) {
                throw new Error('{% trans "Please insert USB Key and try again" %}');
            }
            
            // 2. 验证USB Key数量
            console.log('Step 2: Checking USB Key count...');
            const keyCount = ukeyPlugin.SOF_GetUKeyNumber();
            console.log('Key count:', keyCount);
            
            if (keyCount !== 1) {
                throw new Error('{% trans "Please remove extra USB Keys and try again" %}');
            }
            
            // 3. 获取USB Key句柄
            console.log('Step 3: Getting USB Key handle...');
            const handle = ukeyPlugin.SOF_GetKeyName();
            console.log('Handle result:', handle);
            
            if (!handle) {
                throw new Error('{% trans "Failed to get USB Key handle" %}');
            }
            
            // 4. 验证PIN码并打开应用容器
            console.log('Step 4: Verifying PIN and opening application container...');
            const pinResult = ukeyPlugin.SOF_OpenApplyAndContainer(handle, 'AdminApp', 'AdminContainer', pin);
            console.log('PIN verify result:', pinResult);
            
            if (pinResult !== 0) {
                throw new Error('{% trans "Invalid USB Key PIN" %}');
            }
            
            // 5. 获取证书CN项及序列号
            console.log('Step 5: Getting certificate CN and serial number...');
            const certResult = ukeyPlugin.SOF_GetCertCNAndSerial(handle);
            console.log('Cert result:', certResult);
            
            if (!certResult || certResult.length <= 12) {
                throw new Error('{% trans "Failed to get certificate serial number. Error code: " %}' + certResult);
            }
            
            // 解析证书信息
            const certInfo = certResult.toString();
            const serialNumber = certInfo.substring(certInfo.indexOf(":") + 1);
            const certificateCN = certInfo.substring(0, certInfo.indexOf(":"));
            
            // 6. 生成随机数（客户端随机数 + 服务器随机数 + 证书信息）
            const clientRandom = Math.ceil(Math.random() * 100000000) + "";
            const serverRandom = document.getElementById('server-random').value;
            const random = clientRandom + serverRandom + certResult;
            
            // 7. 数据签名
            console.log('Step 6: Signing data...');
            const signValue = ukeyPlugin.SOF_SM2Sign(handle, random, '0');
            console.log('Signature result:', signValue);
            
            if (!signValue) {
                throw new Error('{% trans "Failed to sign data" %}');
            }
            
            // 8. 设置隐藏字段并提交表单
            document.getElementById('random').value = random;
            document.getElementById('signatureValue-hidden').value = signValue;
            
            // 获取用户名（从URL参数或页面中获取）
            const urlParams = new URLSearchParams(window.location.search);
            const username = urlParams.get('username') || document.getElementById('username').value;
            if (username) {
                document.getElementById('username').value = username;
            }
            
            // 检查是否开启调试模式
            const debugMode = document.getElementById('debug-mode').checked;
            
            if (debugMode) {
                // 调试模式：显示详细信息并延迟提交
                console.log('=== USB Key Authentication Debug Info ===');
                console.log('Client Random:', clientRandom);
                console.log('Server Random:', serverRandom);
                console.log('Certificate Info:', certResult);
                console.log('Combined Random:', random);
                console.log('Signature:', signValue);
                console.log('Username:', username);
                console.log('Next URL:', document.getElementById('next').value);
                
                // 显示调试信息
                showStatus('info', `Debug Info: Random=${random.substring(0, 20)}..., Signature=${signValue.substring(0, 20)}...`);
                
                // 延迟5秒提交，让用户有时间查看网络请求
                setTimeout(() => {
                    console.log('Submitting form in debug mode...');
                    document.getElementById('usb-key-form').submit();
                }, 5000);
            } else {
                // 正常模式：快速提交
                showStatus('success', '{% trans "USB Key authentication successful, submitting..." %}');
                setTimeout(() => {
                    document.getElementById('usb-key-form').submit();
                }, 1000);
            }
            
        } catch (error) {
            console.error('USB Key authentication error:', error);
            showStatus('error', error.message || '{% trans "USB Key authentication failed" %}');
        } finally {
            isAuthenticating = false;
            // 断开连接
            if (ukeyPlugin) {
                ukeyPlugin.SOF_DeviceDisConnect();
            }
        }
    }

    // 网络请求调试功能
    function logNetworkRequest() {
        const form = document.getElementById('usb-key-form');
        const formData = new FormData(form);
        
        console.log('=== Form Data Being Sent ===');
        for (let [key, value] of formData.entries()) {
            if (key === 'sign_value' || key === 'random') {
                console.log(`${key}: ${value.substring(0, 50)}... (length: ${value.length})`);
            } else {
                console.log(`${key}: ${value}`);
            }
        }
        
        // 显示在页面上
        const debugInfo = document.createElement('div');
        debugInfo.style.cssText = 'margin-top: 10px; padding: 10px; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px; font-family: monospace; font-size: 12px;';
        debugInfo.innerHTML = `
            <strong>Network Request Debug Info:</strong><br>
            Random Data: ${formData.get('random').substring(0, 30)}...<br>
            Signature: ${formData.get('sign_value').substring(0, 30)}...<br>
            Username: ${formData.get('username')}<br>
            Server Random: ${formData.get('server_random')}<br>
            Next URL: ${formData.get('next')}
        `;
        
        const formContainer = document.querySelector('.ibox-content');
        formContainer.appendChild(debugInfo);
    }

    // 页面加载完成后初始化
    document.addEventListener('DOMContentLoaded', function() {
        initUSBKeyPlugin();
        
        // 添加表单提交前的调试
        document.getElementById('usb-key-form').addEventListener('submit', function(e) {
            if (document.getElementById('debug-mode').checked) {
                e.preventDefault();
                logNetworkRequest();
                
                // 延迟提交
                setTimeout(() => {
                    this.submit();
                }, 2000);
            }
        });
    });
</script>
</html>
