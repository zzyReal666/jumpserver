(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-ecbb326e"],{"1e05":function(t,e,n){"use strict";n.d(e,"d",(function(){return i})),n.d(e,"c",(function(){return a})),n.d(e,"g",(function(){return r})),n.d(e,"e",(function(){return o})),n.d(e,"b",(function(){return l})),n.d(e,"f",(function(){return c})),n.d(e,"a",(function(){return u}));var s=n("b775");function i(t){return Object(s["c"])({url:"/api/v1/ops/job-execution/task-detail/".concat(t,"/"),method:"get"})}function a(t){return Object(s["c"])({url:"/api/v1/ops/jobs/".concat(t,"/"),method:"get"})}function r(t){return Object(s["c"])({url:"/api/v1/ops/playbooks/",method:"post",headers:{"Content-Type":"multipart/form-data"},data:t})}function o(t,e){return Object(s["c"])({url:"/api/v1/ops/playbook/".concat(t,"/file/"),method:"patch",data:e})}function l(t){return Object(s["c"])({url:"/api/v1/ops/jobs/",method:"post",data:t})}function c(t){return Object(s["c"])({url:"/api/v1/ops/job-executions/stop/",method:"post",data:t})}function u(t){return Object(s["c"])({url:"/api/v1/ops/jobs/upload/",method:"post",headers:{"Content-Type":"multipart/form-data"},timeout:36e5,data:t})}},"428f":function(t,e,n){},"8ab3":function(t,e,n){"use strict";n("be84")},b8d1:function(t,e,n){"use strict";n.r(e);var s=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("Page",[n("el-alert",{staticClass:"announcement",attrs:{center:!1,type:"success"}},t._l(t.FileTransferBootStepHelpTips,(function(e,s){return n("span",{key:s,staticStyle:{"padding-right":"24px"}},[n("span",{staticStyle:{"font-weight":"700",color:"#1C84C6"}},[t._v(t._s(s+1)+".")]),t._v("\n      "+t._s(e)+"\n    ")])})),0),t._v(" "),n("AssetTreeTable",{ref:"AssetTreeTable",attrs:{"tree-setting":t.treeSetting}},[n("template",{slot:"table"},[n("div",{staticClass:"transition-box",staticStyle:{width:"calc(100% - 17px)"}},[n("div",{staticClass:"upload_input"},[n("el-button",{staticStyle:{display:"inline-block",padding:"6px 10px"},attrs:{disabled:t.runButton.disabled,type:t.runButton.el&&t.runButton.el.type,size:"small"},on:{click:function(e){return t.runButton.callback()}}},[n("i",{class:t.runButton.icon,staticStyle:{"margin-right":"4px"}}),t._v(t._s(t.runButton.name)+"\n          ")])],1),t._v(" "),n("span",{staticStyle:{color:"red"}},[t._v("*")]),t._v(" "),n("div",{staticClass:"upload_input"},[t._v(t._s(t.$t("Account"))+":")]),t._v(" "),n("div",{staticClass:"upload_input"},[n("el-autocomplete",{staticStyle:{display:"inline-block",margin:"0 2px"},attrs:{"fetch-suggestions":t.runAsInput.el.query,placeholder:t.runAsInput.placeholder,size:"mini"},on:{change:function(e){return t.runAsInput.callback(t.runAsInput.value)},select:function(e){return t.runAsInput.callback(t.runAsInput.value)}},model:{value:t.runAsInput.value,callback:function(e){t.$set(t.runAsInput,"value",e)},expression:"runAsInput.value"}})],1),t._v(" "),n("div",{staticClass:"upload_input"},[t._v(t._s(t.$t("UploadDir"))+":")]),t._v(" "),n("div",{staticClass:"upload_input"},["input"===t.dstPathInput.type?n("el-input",{attrs:{placeholder:t.dstPathInput.placeholder,size:"mini"},on:{change:function(e){return t.dstPathInput.callback(t.dstPathInput.value)}},model:{value:t.dstPath,callback:function(e){t.dstPath=e},expression:"dstPath"}},[n("template",{slot:"prepend"},[t._v("/tmp/")])],2):t._e()],1),t._v(" "),n("div",{staticClass:"file-uploader"},[n("el-card",[t.ready?n("el-upload",{ref:"upload",attrs:{"auto-upload":!1,"on-change":t.onFileChange,value:t.uploadFileList,action:"",drag:"",multiple:""},on:{"update:value":function(e){t.uploadFileList=e}},scopedSlots:t._u([{key:"file",fn:function(e){var s=e.file;return n("div",{},[n("li",{staticClass:"el-upload-list__item is-ready",attrs:{tabindex:"0"}},[n("a",{staticClass:"el-upload-list__item-name",style:t.sameFileStyle(s)},[n("i",{staticClass:"el-icon-document"}),t._v(t._s(s.name)+"\n                    "),n("i",{staticStyle:{color:"#1ab394",float:"right","font-weight":"normal"}},[t._v("\n                      "+t._s(t.formatFileSize(s.size))+"\n                      "),n("i",{staticClass:"el-icon-close",on:{click:function(e){return t.removeFile(s)}}})])])])])}}],null,!1,2594083562)},[n("i",{staticClass:"el-icon-upload"}),t._v(" "),n("div",{staticClass:"el-upload__text",staticStyle:{"margin-bottom":"10px",padding:"0 5px 0 5px"}},[t._v("\n                "+t._s(t.$t("DragUploadFileInfo"))+"\n              ")]),t._v(" "),n("span",[t._v("\n                "+t._s(t.$t("UploadFileLthHelpText",{limit:t.SizeLimitMb}))+"\n              ")]),t._v(" "),t._v(" "),0===t.uploadFileList.length?n("div",{staticClass:"empty-file-tip",attrs:{slot:"tip"},slot:"tip"},[t._v("\n                "+t._s(t.$tc("NoFiles"))+"\n              ")]):t._e()]):t._e(),t._v(" "),t.ShowProgress?n("el-progress",{attrs:{percentage:t.progressLength}}):t._e()],1)],1),t._v(" "),n("div",{staticStyle:{"margin-bottom":"5px","font-weight":"bold",display:"inline-block"}},[t._v(t._s(t.$tc("Output"))+":")]),t._v(" "),t.executionInfo.status&&t.summary?n("span",{staticStyle:{float:"right"}},[n("span",[n("span",[n("b",[t._v(t._s(t.$tc("Status"))+": ")])]),t._v(" "),"timeout"===t.executionInfo.status?n("span",{staticClass:"status_warning"},[t._v(t._s(t.$tc("Timeout")))]):n("span",[n("span",{staticClass:"status_success"},[t._v(t._s(t.$tc("Success")+": "+t.summary.success))]),t._v(" "),n("span",{staticClass:"status_warning"},[t._v(t._s(t.$tc("Skip")+": "+t.summary.skip))]),t._v(" "),n("span",{staticClass:"status_danger"},[t._v(t._s(t.$tc("Failed")+": "+t.summary.failed))])])]),t._v(" "),n("span",[n("span",[n("b",[t._v(t._s(t.$tc("TimeDelta"))+": ")])]),t._v(" "),n("span",[t._v(t._s(t.executionInfo.timeCost))])])]):t._e(),t._v(" "),n("div",{staticClass:"output"},[n("Term",{ref:"xterm",attrs:{"show-tool-bar":!0,"xterm-config":t.xtermConfig}}),t._v(" "),n("div",{staticStyle:{height:"2px"}})],1),t._v(" "),n("div",{staticStyle:{display:"flex","margin-top":"10px","justify-content":"space-between"}})])])],2)],1)},i=[],a=(n("2caf"),n("ac4d"),n("8a81"),n("5df3"),n("1c4c"),n("6b54"),n("87b3"),n("57e7"),n("7f7f"),n("d25f"),n("ac6a"),n("456d"),n("a481"),n("6d67"),n("ad09")),r=n("ef81"),o=n("83b2"),l=n("1e05"),c=n("dbfd"),u=n("4360");function d(t,e){var n="undefined"!==typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=p(t))||e&&t&&"number"===typeof t.length){n&&(t=n);var s=0,i=function(){};return{s:i,n:function(){return s>=t.length?{done:!0}:{done:!1,value:t[s++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,r=!0,o=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return r=t.done,t},e:function(t){o=!0,a=t},f:function(){try{r||null==n.return||n.return()}finally{if(o)throw a}}}}function p(t,e){if(t){if("string"===typeof t)return f(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?f(t,e):void 0}}function f(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,s=new Array(e);n<e;n++)s[n]=t[n];return s}var h={name:"FileTransfer",components:{AssetTreeTable:a["a"],Page:o["a"],Term:r["a"]},data:function(){var t=this;return{ready:!0,currentStatus:"",currentTaskId:"",executionInfo:{status:"",timeCost:0,cancel:0},xtermConfig:{},DataZTree:0,runas:"",dstPath:"",runButton:{type:"button",name:this.$t("Transfer"),align:"left",icon:"fa fa-play",disabled:this.$store.getters.currentOrgIsRoot||!this.$hasPerm("ops.add_job"),el:{type:"primary"},callback:function(){setTimeout((function(){t.execute()}),300)}},runAsInput:{name:this.$t("RunAs"),align:"left",value:"",placeholder:this.$tc("EnterRunUser"),el:{autoComplete:!0,query:function(e,n){var s=t.getSelectedNodesAndHosts(),i=s.hosts,a=s.nodes;t.$axios.post("/api/v1/ops/username-hints/",{nodes:a,assets:i,query:e}).then((function(t){var e=t.map((function(t){return{value:t.username}}));n(e)}))}},options:[],callback:function(e){t.runas=e}},dstPathInput:{type:"input",name:this.$t("RunningPath"),align:"left",value:"",placeholder:this.$tc("EnterUploadPath"),callback:function(e){t.chdir=e}},treeSetting:{treeUrl:"/api/v1/perms/users/self/nodes/children-with-assets/tree/",searchUrl:"/api/v1/perms/users/self/assets/tree/",notShowBuiltinTree:!0,showRefresh:!0,showMenu:!1,showSearch:!0,check:{enable:!0},view:{dblClickExpand:!1,showLine:!0}},iShowTree:!0,progressLength:0,ShowProgress:!1,upload_interval:null,uploadFileList:[],SizeLimitMb:u["a"].getters.publicSettings["FILE_UPLOAD_SIZE_LIMIT_MB"],summary:{success:0,failed:0,skip:0},FileTransferBootStepHelpTips:[this.$tc("FileTransferBootStepHelpTips1"),this.$tc("FileTransferBootStepHelpTips2"),this.$tc("FileTransferBootStepHelpTips3")]}},computed:{xterm:function(){return this.$refs.xterm.xterm},ztree:function(){return this.$refs.AssetTreeTable.$refs.TreeList.$refs.AutoDataZTree.$refs.AutoDataZTree.$refs.dataztree.$refs.ztree}},mounted:function(){this.enableWS()},methods:{formatFileSize:c["g"],enableWS:function(){var t=this,e="https:"===document.location.protocol?"wss":"ws",n=document.location.port?":"+document.location.port:"",s="/ws/ops/tasks/log/",i=e+"://"+document.location.hostname+n+s;this.ws=new WebSocket(i),this.ws.onerror=function(e){t.xterm.write(t.wrapperError("Connect websocket server error"))},this.setWsCallback()},setWsCallback:function(){var t=this;this.ws.onmessage=function(e){var n=JSON.parse(e.data);if(n.hasOwnProperty("message")){var s=n.message;s=s.replace(/Task ops\.tasks\.run_ops_job_execution.*/,""),t.xterm.write(s)}"end"===(null===n||void 0===n?void 0:n.event)&&setTimeout((function(){clearInterval(t.executionInfo.cancel),t.execute_stop(),t.getTaskStatus()}),500)}},taskStatusStat:function(t){var e=t.ok,n=void 0===e?[]:e,s=t.failures,i=void 0===s?[]:s,a=t.dark,r=void 0===a?[]:a,o=t.excludes,l=void 0===o?[]:o,c=t.skipped,u=void 0===c?[]:c,d=Object.keys(i),p=Object.keys(r),f=Object.keys(l);this.summary["success"]=n.length,this.summary["failed"]=d.length+p.length,this.summary["skip"]=f.length+u.length},getTaskStatus:function(){var t=this;Object(l["d"])(this.currentTaskId).then((function(e){t.executionInfo.status=e["status"],t.taskStatusStat(e["summary"]),"success"===t.executionInfo.status&&(t.$message.success(t.$tc("RunSucceed")),clearInterval(t.upload_interval),t.progressLength=100,t.ShowProgress=!0)}))},wrapperError:function(t){return"\r\n".concat(t,"\r\n")},writeExecutionOutput:function(){var t=this.$t("Pending");this.xterm.write(t),t=JSON.stringify({task:this.currentTaskId}),this.ws.send(t)},getSelectedNodes:function(){return this.ztree.getCheckedNodes().filter((function(t){var e=t.getCheckStatus();return"search"!==t.id&&!1===e.half}))},setCostTimeInterval:function(){var t=this;this.runButton.icon="fa fa-spinner fa-spin",this.runButton.disabled=!0,this.executionInfo.cancel=setInterval((function(){t.executionInfo.timeCost+=1}),1e3)},getSelectedNodesAndHosts:function(){var t=this.getSelectedNodes().filter((function(t){return"node"!==t.meta.type})).map((function(t){return t.id})),e=this.getSelectedNodes().filter((function(t){return"node"===t.meta.type})).map((function(t){return t.meta.data.id}));return{hosts:t,nodes:e}},truncateFileName:function(t){var e=130;if(t.length<=e)return t;var n=t.slice(0,e/2),s=t.slice(-e/2);return n+"..."+s},handleSameFile:function(t){var e,n=t.map((function(t){return t.name})),s=_.countBy(n),i=d(t);try{for(i.s();!(e=i.n()).done;){var a=e.value;a.isSame=s[a.name]>1}}catch(r){i.e(r)}finally{i.f()}},sameFileStyle:function(t){return t.isSame?{backgroundColor:"var(--color-danger)"}:""},isFileExceedsLimit:function(t){var e=t.size/1024/1024>this.SizeLimitMb;return e&&this.$message.error(this.$tc("FileSizeExceedsLimit")),e},onFileChange:function(t,e){t.name=this.truncateFileName(t.name),this.uploadFileList=e,this.handleSameFile(e)},removeFile:function(t){this.uploadFileList.splice(this.uploadFileList.indexOf(t),1),this.handleSameFile(this.uploadFileList)},execute:function(){var t,e=this,n=this.getSelectedNodesAndHosts(),s=n.hosts,i=n.nodes,a=d(this.uploadFileList);try{for(a.s();!(t=a.n()).done;){var r=t.value;if(r.isSame)return void this.$message.error(this.$tc("DuplicateFileExists"));if(this.isFileExceedsLimit(r))return;if(r.name.length>128)return void this.$message.error(r.name+" "+this.$tc("FileNameTooLong"))}}catch(c){a.e(c)}finally{a.f()}if(0!==this.uploadFileList.length)if(0!==s.length||0!==i.length)if(this.runas){var o={assets:s,nodes:i,module:"shell",args:JSON.stringify({dst_path:this.dstPath}),type:"upload_file",runas:this.runas,runas_policy:"skip",instant:!1,is_periodic:!1,timeout:-1};this.chdir&&(o.chdir=this.chdir),Object(l["b"])(o).then((function(t){e.progressLength=0,e.executionInfo.timeCost=0,e.ShowProgress=!0;var n,s=new FormData,i=d(e.uploadFileList);try{for(i.s();!(n=i.n()).done;){var a=n.value;s.append("files",a.raw),s.append("job_id",t.id)}}catch(c){i.e(c)}finally{i.f()}e.upload_interval=setInterval((function(){e.progressLength>=99?clearInterval(e.upload_interval):e.progressLength+=1}),100),Object(l["a"])(s).then((function(t){e.executionInfo.status="running",e.currentTaskId=t.task_id,e.xtermConfig={taskId:e.currentTaskId,type:"shortcut_cmd"},e.setCostTimeInterval(),e.writeExecutionOutput()})).catch((function(){e.execute_stop()}))}))}else this.$message.error(this.$tc("RequiredRunas"));else this.$message.error(this.$tc("RequiredAssetOrNode"));else this.$message.error(this.$tc("RequiredUploadFile"))},execute_stop:function(){this.progressLength=0,this.ShowProgress=!1,this.runButton.disabled=!1,clearInterval(this.upload_interval),this.runButton.icon="fa fa-play"}}},m=h,v=(n("d2df"),n("2877")),g=Object(v["a"])(m,s,i,!1,null,"adc593a4",null);e["default"]=g.exports},be84:function(t,e,n){},d2df:function(t,e,n){"use strict";n("428f")},ef81:function(t,e,n){"use strict";var s=function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticStyle:{position:"relative"}},[t.showToolBar?n("div",{staticClass:"actions"},t._l(t.toolbar,(function(e,s){return n("div",{key:s,staticStyle:{display:"inline-block"}},[n("el-tooltip",{attrs:{content:e.tip,"open-delay":500}},[!e.isScrollButton||t.showScrollButton?n("el-button",{attrs:{size:"mini",type:"default"},on:{click:function(t){return e.callback()}}},[n("svg-icon",{attrs:{"icon-class":e.icon}})],1):t._e()],1)],1)})),0):t._e(),t._v(" "),n("div",{ref:"terminal",staticClass:"xterm",attrs:{id:"terminal"}})])},i=[],a=(n("abb2"),n("fcf3")),r=n("47d0"),o=n("dbfd"),l={name:"Term",props:{showToolBar:{type:[Boolean,Object],default:function(){return!1}},xtermConfig:{type:Object,default:function(){}}},data:function(){var t=this;return{xterm:new a["Terminal"](Object.assign({fontFamily:'monaco, Consolas, "Lucida Console", monospace',lineHeight:1.2,fontSize:13,rightClickSelectsWord:!0,theme:{background:"#fff",foreground:"#000",selection:"#363535"}},this.xtermConfig)),toolbar:[{tip:this.$tc("ScrollToTop"),icon:"arrow-up",callback:function(){t.xterm.scrollToTop()},isScrollButton:!0},{tip:this.$tc("ScrollToBottom"),icon:"arrow-down",callback:function(){t.xterm.scrollToBottom()},isScrollButton:!0},{tip:this.$tc("ClearScreen"),icon:"refresh",callback:function(){t.xterm.reset()}},{tip:this.$tc("Export"),icon:"download",callback:function(){var e,n;t.xterm.selectAll();var s=t.xterm.getSelection(),i="".concat(null===(e=t.xtermConfig)||void 0===e?void 0:e.type,"_").concat(null===(n=t.xtermConfig)||void 0===n?void 0:n.taskId,".log");Object(o["f"])(s,i)}}],showScrollButton:!1}},mounted:function(){var t=this.$refs.terminal,e=new r["FitAddon"];this.xterm.loadAddon(e),this.xterm.open(t),e.fit(),this.xterm.scrollToBottom(),this.xterm.onScroll(this.checkScroll)},beforeDestroy:function(){this.xterm.dispose()},methods:{reset:function(){this.xterm.reset()},write:function(t){this.xterm.write(t)},checkScroll:function(t){this.showScrollButton=t>0}}},c=l,u=(n("8ab3"),n("2877")),d=Object(u["a"])(c,s,i,!1,null,"0c8c1df8",null);e["a"]=d.exports}}]);